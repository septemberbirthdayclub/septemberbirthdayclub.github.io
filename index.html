<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title> SBC crossword </title>
<link rel="icon" href="eyes.png" type="image/png">
<style>
    body { background-color:#000; color:#fff; font-family:sans-serif; text-align:center; }
    table { border-collapse: collapse; margin:20px auto; }
    td { width:40px; height:40px; border:1px solid #000; position:relative; background-color:#000; }
    td .label { position:absolute; top:1px; left:2px; font-size:12px; color:#000; }
    td input { width:100%; height:100%; border:none; background:transparent; color:#000; font-size:24px; text-align:center; text-transform:lowercase; }
    td input:focus { outline:2px solid #6b9fe4; }
    .sidebar { width:fit-content; background-color:#fff; color:#000; padding:10px; margin-right:20px; border-radius:0px; height:fit-content; float:left; }
    .clue-columns { display:flex; justify-content:space-between; }
    .clues { width:90%; }
    .clues.across { text-align:left; }
    .clues.down { text-align:left; }
</style>
</head>
<body>

<h1>Your gifts are just around the corner!</h1>

<div class="sidebar">
    <div class="clue-columns">
        <!-- Across clues column -->
        <div class="clues across">
            <h2>Across</h2>
            <div>(1) With 11 down, operation performed on pancakes and the letters in each of the colored boxes.</div>
            <div>(5) Laura Jensen expletive </div>
            <div>(7) head first, to Maria</div>
            <div>(9) Alex Smith title (abbr.) </div>
            <div>(10) as well </div>
            <div>(12) summer program for S & Z</div>
            <div>(13) Office on Melby St. in EC </div>
            <div>(14) Top of the hill, nowadays</div>
            <div>(15) Ending for ass, leg, and subs</div>
            <div>(16) see 7 down (inits)</div>
            <div>(17) all-encompassing baseball stat</div>
            <div>(18) Birgatzi & Mulaney, e.g.</div>
            <div>(23) Sticks carried by wizards</div>
            <div>(24) with 5 down, these should be used before merging? </div>
        </div>

        <!-- Down clues column -->
        <div class="clues down">
            <h2>Down</h2>
            <div>(1) ___ Four, or the Beatles</div>
            <div>(2) L+1 is the ____ element of Î£<sub>n=1</sub>(n+1)</div>
            <div>(3) Wells who co-founded the NAACP</div>
            <div>(4) Campaigner, casually</div>
            <div>(5) See 24 across</div>
            <div>(6) large commits</div>
            <div>(7) birthday gift of choice for 16 across</div>
            <div>(8) Something Ms. Nelson might check for</div>
            <div>(9) buggy, in Britain</div>
            <div>(11) see 1 across</div>
            <div>(19) Cell energy currency (abbr.)</div>
            <div>(20) Sophie Collier alma mater (abbr.)</div>
            <div>(21) Our place at Kubb Nationals (abbr.)</div>
            <div>(22) Org. for the Packers and the Jets</div>
        </div>
    </div>
</div>

<table id="crossword"></table>
<button id="submit">Submit</button>

<script>
const numRows = 10;
const numCols = 10;

// Labeled cells: [row, col, labelNumber]
const labelCells = [
    [3,0,'1'],[4,0,'2'],[5,0,'3'],[6,0,'4'],
    [2,1,'5'],[7,1,'6'],
    [1,2,'7'], [8,2,'8'],
    [0,3,'9'],[7,3,'10'],[9,3,'11'],
    [0,4,'12'],[7,4,'13'],
    [0,5,'14'],[7,5,'15'],
    [0,6,'16'],[7,6,'17'],
    [1,7,'18'], [3,7,'19'], [4,7,'20'], [5,7,'21'], [6,7,'22'],
    [2,8,'23'],
    [3,9,'24']
];

// Non-labeled cells: [row, col]
const nonLabelCells = [
    [3,1],[4,1],[5,1],[6,1],
    [2,2],[3,2],[4,2],[5,2],[6,2],[7,2],
    [1,3],[2,3],[8,3],
    [1,4],[2,4],[8,4],[9,4],
    [1,5],[2,5],[8,5],[9,5],
    [1,6],[2,6],[8,6],[9,6],
    [2,7],[7,7],[8,7],
    [3,8],[4,8],[5,8],[6,8],[7,8],
    [4,9],[5,9],[6,9]
];

// Colored cells: [row,col]:color
const coloredCells = {
    "3,2":"#b8ffb2",
    "2,3":"#b8ffb2",
    "7,6":"#b8ffb2",
    "6,7":"#b8ffb2"
};

// Combine all cells that should have an input
const inputCells = [...labelCells.map(c => [c[0],c[1]]), ...nonLabelCells];

const table = document.getElementById('crossword');

for (let i=0; i<numRows; i++) {
    const tr = document.createElement('tr');
    for (let j=0; j<numCols; j++) {
        const td = document.createElement('td');

        // Default: black background
        td.style.backgroundColor = '#000';

        // Check if labeled or non-labeled
        const label = labelCells.find(cell => cell[0] === j && cell[1] === i);
        const isNonLabel = nonLabelCells.find(cell => cell[0] === j && cell[1] === i);

        // If labeled or non-labeled, set background to white
        if (label || isNonLabel) {
            td.style.backgroundColor = '#fff';
        }

        // Add label number if present
        if (label) {
            const span = document.createElement('span');
            span.className = 'label';
            span.textContent = label[2];
            td.appendChild(span);
        }

        // Override background if colored
        const key = `${i},${j}`;
        if (coloredCells[key]) {
            td.style.backgroundColor = coloredCells[key];
        }

        // Add input only for cells that would have a text area
        if (inputCells.some(c => c[0]===i && c[1]===j)) {
            const input = document.createElement('input');
            input.maxLength = 1;
            input.dataset.key = `${j},${i}`; // <-- add this line
            td.appendChild(input);
        }

        tr.appendChild(td);
    }
    table.appendChild(tr);
}
let encryptedSolution = {}; // will be filled dynamically
let secretMessageEnc = {}; // will be filled dynamically

// Fetch the JSON file
async function loadEncryptedSolution() {
    try {
        const response = await fetch('public_crossword_answers.json'); // make sure outputs.json is in the same folder
        if (!response.ok) throw new Error('Failed to load JSON: ' + response.status);
        encryptedSolution = await response.json();
    } catch (err) {
        console.error(err);
    }
}
async function loadEncryptedSuccess() {
    try {
        const win_response = await fetch('public_success.json'); // make sure outputs.json is in the same folder
        if (!win_response.ok) throw new Error('Failed to load JSON: ' + win_response.status);
        secretMessageEnc = await win_response.json();
    } catch (err) {
        console.error(err);
    }
}
// Call it when page loads
loadEncryptedSolution();
loadEncryptedSuccess();

// --- AES decryption helpers ---
function base64ToBytes(str) {
    str = str.trim();
    return Uint8Array.from(atob(str), c => c.charCodeAt(0));
}
function strToBuffer(str){ return new TextEncoder().encode(str); }
function bufferToStr(buf){ return new TextDecoder().decode(buf); }
function unpad(s){ return s.replace(/\s+$/,''); }
// --- Derive raw AES key bytes from password + salt ---
async function deriveKeyBytes(password, saltBase64) {
    const salt = base64ToBytes(saltBase64);
    const keyMaterial = await crypto.subtle.importKey(
        "raw", strToBuffer(password), "PBKDF2", false, ["deriveBits"]
    );
    // derive 256 bits exactly, matching Java
    const keyBits = await crypto.subtle.deriveBits(
        { name:"PBKDF2", salt: salt, iterations: 65536, hash: "SHA-256" },
        keyMaterial,
        256
    );
    // import raw key for AES-CBC
    return crypto.subtle.importKey(
        "raw",
        keyBits,
        { name: "AES-CBC" },
        false,
        ["decrypt"]
    );
}

// --- Decrypt a single encrypted entry ---
async function decryptCell(encDict, password) {
    try {
        const iv = base64ToBytes(encDict.iv);
        const cipherText = base64ToBytes(encDict.cipher_text);
        const key = await deriveKeyBytes(password, encDict.salt);

        const decryptedBuffer = await crypto.subtle.decrypt(
            { name: "AES-CBC", iv: iv },
            key,
            cipherText
        );

        return unpad(bufferToStr(decryptedBuffer));
    } catch (e) {
        return null; // failed decryption (wrong password)
    }
}


// --- Check a cell input against all encrypted entries ---
async function checkCellAnswers(encList, userAnswer){
    for(const enc of encList){
        const decrypted = await decryptCell(enc, userAnswer);
        if(decrypted==="ImAGreeeeeeeenChicken"){
            return true; // correct answer
        }
    }
    return false; // no match
}

async function checkFullSolution(encList, userAnswer){
    const win_decrypted = await decryptCell(encList[0], userAnswer);
    if(win_decrypted){
        return win_decrypted;
    }
    return null; // no match
}

function getFullSolutionString() {
    const inputs = document.querySelectorAll("#crossword input");
    let solution = "";
    inputs.forEach(inp => solution += inp.value.trim().toLowerCase());
    return solution;
}

// --- Submit handler ---
document.getElementById("submit").addEventListener("click", async () => {
    // Get all crossword inputs
    const allInputs = document.querySelectorAll("#crossword input");

    // Check if any box is empty
    for (const input of allInputs) {
        if (input.value.trim() === "") {
            alert("Please fill in all boxes before submitting!");
            return; // stop submission
        }
    }
    let incorrect = [];
    for (const [cell, encryptedAnswers] of Object.entries(encryptedSolution)) {
        const input = document.querySelector(`input[data-key='${cell}']`);
        if(!input) continue;
        const userVal = input.value.trim().toLowerCase();
        const correct = await checkCellAnswers(encryptedAnswers,userVal);
        if (correct) {
            //input.style.backgroundColor = "#6b9fe4"; // blue for correct
        } else {
            //input.style.backgroundColor = "#f88"; // red for wrong
            incorrect.push({cell,input:userVal});
        }
    }

    if (incorrect.length === 0) {
        for (const [cell, encryptedSecret] of Object.entries(secretMessageEnc)) {
            const password = getFullSolutionString(); // use whole grid as key;
            const secret = await checkFullSolution(encryptedSecret, password);

            if (secret) {
                // replace all _ with spaces in secret
                alert("Success!! " + secret.replace(/_/g, ' '));
            } else {
                alert("Crossword solved, but message decryption failed... contact SBCCC");
            }
        }
    } else {
        let msg="Something's not quite right! \n";
        // if len incorrect < or equal to 4: print a helpful message 
        if(incorrect.length <= 4){
            msg += 'across answers must supercede down answers\n';
            alert(msg);
        } else {
            msg += 'Keep trying! \n';
        }
        alert(msg);
        }
});
</script>
</body>
</html>
